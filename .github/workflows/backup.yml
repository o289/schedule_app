name: Daily DB Backup

on:
  schedule:
    # æ¯æ—¥ åˆå‰3æ™‚ (UTC) ã«å®Ÿè¡Œ â†’ æ—¥æœ¬æ™‚é–“ã§åˆå‰12æ™‚
    - cron: "0 3 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Backup DB on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /home/${{ secrets.VPS_USER }}/schedule_app
            mkdir -p backups
            docker compose -f infra/docker/docker-compose.prod.yml exec -T db \
            sh -c 'pg_dump -U "$POSTGRES_USER" "$POSTGRES_DB"' \
            > backups/backup_$(date +%F_%H-%M).sql

            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ãªã„ã‹ç¢ºèª
            BACKUP_FILE=$(ls -t backups/backup_*.sql | head -n1)
            if [ ! -s "$BACKUP_FILE" ]; then
            echo "âŒ Backup file is empty!"
            exit 1
            fi
            echo "âœ… Backup completed: $BACKUP_FILE"

            # ä¸æ­£ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ•´åˆæ€§ç¶­æŒï¼‰
            echo "ğŸ§¹ Cleaning invalid and orphaned schedules..."
            docker compose -f infra/docker/docker-compose.prod.yml exec -T db \
            psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c \
            "DELETE FROM schedule_dates WHERE end_date <= start_date; \
             DELETE FROM schedules WHERE NOT EXISTS (SELECT 1 FROM schedule_dates WHERE schedule_dates.schedule_id = schedules.id);"
            echo "âœ… Clean-up completed."
