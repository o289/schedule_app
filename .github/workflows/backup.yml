name: Daily DB Backup

on:
  schedule:
    # 毎日 午前3時 (UTC) に実行 → 日本時間で午前12時
    - cron: "0 3 * * *"

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Backup DB on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
            host: ${{ secrets.VPS_HOST }}
            username: ${{ secrets.VPS_USER }}
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
                cd /home/${{ secrets.VPS_USER }}/schedule_app
                mkdir -p backups
                docker compose -f docker-compose.prod.yml exec -T db \
                sh -c 'pg_dump -U "$POSTGRES_USER" "$POSTGRES_DB"' \
                > backups/backup_$(date +%F_%H-%M).sql

                # バックアップファイルが空でないか確認
                BACKUP_FILE=$(ls -t backups/backup_*.sql | head -n1)
                if [ ! -s "$BACKUP_FILE" ]; then
                echo "❌ Backup file is empty!"
                exit 1
                fi
                echo "✅ Backup completed: $BACKUP_FILE"