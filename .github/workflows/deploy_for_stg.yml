name: Deploy STG (manual, destructive)
on:
    workflow_dispatch:

jobs:
    deploy-stg:
        runs-on: ubuntu-latest

        steps:
            # 1. „É™„Éù„Ç∏„Éà„É™ÂèñÂæó
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2-5. Deploy STG in single SSH session
            - name: Deploy STG in single SSH session
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd /home/${{ secrets.VPS_USER }}
                      if [ ! -d "schedule_app" ]; then
                        echo "üì• Cloning repository..."
                        git clone https://github.com/o289/schedule_app.git
                      fi

                      cd schedule_app
                      echo "üîÑ Syncing release branch..."
                      git fetch origin
                      git checkout -B ${{ github.ref_name }} origin/${{ github.ref_name }}

                      echo "üß® Removing STG containers and volumes..."
                      docker compose -f docker-compose.stg.yml down -v || true

                      echo "üî® Building STG images..."
                      docker compose -f docker-compose.stg.yml build --no-cache

                      echo "üöÄ Starting STG environment..."
                      docker compose -f docker-compose.stg.yml up -d

            - name: Verify deployed commit (STG)
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd /home/${{ secrets.VPS_USER }}/schedule_app
                      DEPLOYED_COMMIT=$(docker compose -f docker-compose.stg.yml exec -T backend git rev-parse HEAD)
                      EXPECTED_COMMIT=$(git rev-parse ${{ github.sha }})
                      echo "Deployed commit: $DEPLOYED_COMMIT"
                      echo "Expected commit: $EXPECTED_COMMIT"
                      if [ "$DEPLOYED_COMMIT" != "$EXPECTED_COMMIT" ]; then
                        echo "‚ùå Deployed commit does not match expected commit."
                        exit 1
                      else
                        echo "‚úÖ Deployed commit matches expected commit."
                      fi

            # 6. „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÔºàÂ§±Êïó„Åó„Åü„ÇâÊ≠¢„ÇÅ„ÇãÔºâ
            - name: Run Alembic migrations (STG)
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd /home/${{ secrets.VPS_USER }}/schedule_app
                      echo "üóÑÔ∏è Running Alembic migrations on STG..."
                      docker compose -f docker-compose.stg.yml run --rm backend alembic upgrade head

            # 7. Á∞°Êòì„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
            - name: Health check (STG)
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      echo "üîç Checking STG endpoint..."
                      curl -f https://stg-sukejuru.yudais-prod.com || exit 1

            # 8. Â§±ÊïóÊôÇ„É≠„Ç∞ÔºàÊúÄ‰ΩéÈôêÔºâ
            - name: Collect logs on failure
              if: failure()
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd /home/${{ secrets.VPS_USER }}/schedule_app
                      docker compose -f docker-compose.stg.yml logs --tail=200
