name: Deploy STG (manual, destructive)
on:
  workflow_dispatch:

jobs:
  deploy-stg:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2-5. Deploy STG in single SSH session
      - name: Deploy STG in single SSH session
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸ”’ Checking release branch guard..."
            if [[ "${{ github.ref_name }}" != release/* ]]; then
              echo "âŒ This workflow can only be run for release branches."
              exit 1
            fi
            cd /home/${{ secrets.VPS_USER }}
            if [ ! -d "schedule_app" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/o289/schedule_app.git
            fi

            cd schedule_app
            echo "ğŸ”„ Syncing release branch..."
            git fetch origin
            TARGET_RELEASE_BRANCH="${{ github.ref_name }}"
            git checkout -B "$TARGET_RELEASE_BRANCH" "origin/$TARGET_RELEASE_BRANCH"
            git clean -fdx

            echo "ğŸ§¨ Removing STG containers and volumes..."
            docker compose -f docker-compose.stg.yml down -v || true

            echo "ğŸ”¨ Building STG images..."
            docker compose -f docker-compose.stg.yml build --no-cache

            echo "ğŸš€ Starting STG environment..."
            docker compose -f docker-compose.stg.yml up -d

      # 6. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¤±æ•—ã—ãŸã‚‰æ­¢ã‚ã‚‹ï¼‰
      - name: Run Alembic migrations (STG)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /home/${{ secrets.VPS_USER }}/schedule_app
            echo "ğŸ—„ï¸ Running Alembic migrations on STG..."
            docker compose -f docker-compose.stg.yml run --rm backend alembic upgrade head

      # 7. ç°¡æ˜“ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Health check (STG)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸ” Checking STG endpoint..."
            curl -f https://stg-sukejuru.yudais-prod.com || exit 1

      # 8. å¤±æ•—æ™‚ãƒ­ã‚°ï¼ˆæœ€ä½é™ï¼‰
      - name: Collect logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /home/${{ secrets.VPS_USER }}/schedule_app
            docker compose -f docker-compose.stg.yml logs --tail=200
